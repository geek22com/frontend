{% extends "cabinetcpa/offers/info/layout.html" %}
{% import 'common/macros/lists.html' as lists with context %}
{% import 'common/materials.html' as materials_macros %}

{% set activetab = 'materials' %}

{% block extrahead %}
	{{ super() }}
	<style type="text/css">
		.code-box, .code-box[readonly] {
			background-color: #FFF;
			cursor: text;
		}
		
		.span80 {
			width: 78px;
		}
		
		.span220 {
			width: 225px;
		}

		.span160 {
			width: 176px;
		}
		
		.code-settings-body {
			margin-top: 10px;
		}
	</style>
	<script type="text/javascript">
		$(function() {

			function getFormValue(id) {
				var input = $(id);
				return input ? $.trim(input.val()) : '';
			}
			
			function updateCodes() {
				var bannerId = $(document).data('bannerId');
				if (bannerId) {
					var bannerUrl = $(document).data('bannerUrl');
					var bannerWidth = $(document).data('bannerWidth');
					var bannerHeight = $(document).data('bannerHeight');
				}
				
				var placement = getFormValue('#placement');
				var subId  = getFormValue('#subid');
				var subId1 = getFormValue('#subid1');
				var subId2 = getFormValue('#subid2');
				var subId3 = getFormValue('#subid3');
				var subId4 = getFormValue('#subid4');
				var sourceId = getFormValue('#sourceid');
				var ulp = getFormValue('#ulp');
				var cashBack = getFormValue('#cashback');
				
				var params = [];
				if (bannerId) params.push('banner_id=' + bannerId);
				if (subId) params.push('sub_id=' + encodeURIComponent(subId));
				if (subId1) params.push('sub_id1=' + encodeURIComponent(subId1));
				if (subId2) params.push('sub_id2=' + encodeURIComponent(subId2));
				if (subId3) params.push('sub_id3=' + encodeURIComponent(subId3));
				if (subId4) params.push('sub_id4=' + encodeURIComponent(subId4));
				if (sourceId) params.push('source_id=' + encodeURIComponent(sourceId));

				var apiUrl = '{{ config.get("TRACKER_API_URL") -}}';
				var showUrl = apiUrl + '/show/' + placement + (params.length ? '?' + params.join('&') : '');

				if (ulp) params.push('&ulp=' + encodeURIComponent(ulp));
				if (cashBack) params.push('&cashback=' + encodeURIComponent(cashBack));

				var clickUrl = apiUrl + '/click/' + placement + (params.length ? '?' + params.join('&') : '');
				
				var pixelCode = '<img src="' + showUrl +
					'" alt="" style="width: 0; height: 0; position: absolute;" />';
				var bannerCode = '<a href="' + clickUrl + '"><img src="' + bannerUrl
					+ '" alt="" width="' + bannerWidth + '" height="' + bannerHeight
					+ '" /></a>' + pixelCode;
					
				$('#click-url').text(clickUrl);
				$('#tracking-pixel').text(pixelCode);
				$('#banner-code').text(bannerCode);
			}
			
			$('.gen-trigger').change(updateCodes);
			
			$('.code-settings-trigger').click(function() {
				$('.code-settings-body').slideToggle('fast', function() {
					$('.code-settings-trigger').text($(this).is(':visible') ? '[скрыть]' : '[показать]');					
				});
				return false;
			});
			
			$('.code-settings-clear').click(function() {
				$('.gen-trigger').val('');
				updateCodes();
				return false;
			});
			
			$('.code-trigger').click(function() {
				$(document).data('bannerId', $(this).data('bannerId') || '');
				$(document).data('bannerUrl', $(this).data('bannerUrl') || '');
				$(document).data('bannerWidth', $(this).data('bannerWidth') || '');
				$(document).data('bannerHeight', $(this).data('bannerHeight') || '');
				
				$('.code-box-container').hide();
				if ($(this).data('bannerId')) {
					$('.banner-code-container').show();
				}
				else {
					$('.click-url-container').show();
					$('.tracking-pixel-container').show();
				}
				
				updateCodes();
			});
		})
	</script>
{% endblock %}

{% set advertiser_is_owner = g.user.is_advertiser and offer.owned_by(g.user) %}
{% set affiliate_is_granted = g.user.is_affiliate and placements %}

{% block tabcontent %}

{% if advertiser_is_owner %}
	<form method="post" action="" class="widelabels validate2" enctype="multipart/form-data">
		<fieldset>
			<legend>Загрузка баннера</legend>
			{% call forms.singlefield_desc(form.image) %}
			<span class="help-block">
				Принимаются изображения в формате JPG (JPEG), GIF, PNG, SWF (Flash), SVG.
				Максимальный размер загружаемого изображения &mdash; 1Мб.
			</span>
			{% endcall %}
			<div class="actions">
				<input class="btn primary" type="submit" value="Загрузить" style="margin-right: 30px;" />
				<a href="{{ url_for('.offers_info_materials_upload', id=offer.id) }}"
				 >загрузить большое количество изображений</a>
			</div>
		</fieldset>
	</form>
{% endif %}

{% if g.user.is_affiliate %}
	{% if placements %}
		<div class="clearfix alert-message block-message info">
			<p>
				У Вас имеются активные размещения данной рекламной кампании. Коды баннеров Вы можете получить ниже. Если вы не желаете использовать баннеры, вы можете получить код партнерской ссылки отдельно.
			</p>
			<div class="alert-actions">
				<a class="btn small code-trigger" href="#" data-controls-modal="modal-code"
				 data-backdrop="true" data-keyboard="true">Получить код партнерской ссылки</a>
			</div>
		</div>
	{% else %}
		<div class="clearfix alert-message block-message info">
			<p>
				Для того, чтобы получить партнерскую ссылку для данной рекламной кампании, у Вас должны быть активные
				размещения этой кампании на Ваших площадках.	
			</p>
			<div class="alert-actions">
				<a href="{{ url_for('.offers_info_placements', id=offer.id) }}">Управление размещениями</a>
			</div>
		</div>
	{% endif %}
{% endif %}

{% if banners %}
	{% if advertiser_is_owner %}
	<form method="post" action="">
		<div class="well right">
			<input type="submit" value="Удалить выбранные баннеры" class="btn danger banner-action"
			 onclick="return confirm('Удалить выбранные баннеры?');" />
		</div>
		<div class="data-list" data-action-class="banner-action">
			{% call(head, banner) materials_macros.table(banners, colspan=5) %}
				{% if head %}
				<th class="center minimal-width">
					<input type="checkbox" class="data-list-select-all-checkbox" />
				</th>
				{% else %}
				<td class="center">
					<input type="checkbox" class="data-list-item-checkbox" name="id" value="{{ banner.id -}}" />
				</td>
				{% endif %}
			{% endcall %}
		</div>
	</form>
	{% elif affiliate_is_granted %}
		{% call(head, banner) materials_macros.table(banners, colspan=5) %}
			{% if head %}
				<th class="header minimal-width"></th>
			{% else %}
				<td>
					{% if banner.has_code %}
					<a href="#" data-controls-modal="modal-code" data-backdrop="true" data-keyboard="true"
					class="code-trigger" data-banner-id="{{ banner.id }}" data-banner-url="{{ banner.image_url}}"
					data-banner-width="{{ banner.width }}" data-banner-height="{{ banner.height }}">получить&nbsp;код</a>
					{% else %}
					&mdash;
					{% endif %}
				</td>
			{% endif %}
		{% endcall %}
	{% else %}
		{% call(head, banner) materials_macros.table(banners, colspan=4) %}{% endcall %}
	{% endif %}
	{{ lists.paginate(pages, id=offer.id) }}
{% else %}
	<div class="clearfix alert-message block-message info">
		<p><strong>Список пуст.</strong> Еще не было добавлено никаких материалов.</p>
	</div>
{% endif %}

{% endblock %}

{% block postbody %}
	{{ super() }}
	{% if affiliate_is_granted %}
	<div id="modal-code" class="modal fade" style="display: none;">
		<div class="modal-header">
			<a href="#" class="close">×</a>
			<h3>Партнерская ссылка</h3>
		</div>
		<div class="modal-body">
			<form class="stacked">
				<input type="hidden" id="banner-id" />
				<div class="well span code-settings" style="width: 480px;">
					<div class="code-settings-head">
						<b>Дополнительные параметры</b>
						<a href="#" class="code-settings-trigger dotted-link">[показать]</a>
					</div>
					<div class="code-settings-body" style="display: none;">
						<div class="clearfix row">
							<div class="span80">
								<label for="subid">SubID</label>
								<input type="text" id="subid" class="subid span80 gen-trigger" />
							</div>
							<div class="span80">
								<label for="subid1">SubID1</label>
								<input type="text" id="subid1" class="subid span80 gen-trigger" />
							</div>
							<div class="span80">
								<label for="subid2">SubID2</label>
								<input type="text" id="subid2" class="subid span80 gen-trigger" />
							</div>
							<div class="span80">
								<label for="subid3">SubID3</label>
								<input type="text" id="subid3" class="subid span80 gen-trigger" />
							</div>
							<div class="span80">
								<label for="subid4">SubID4</label>
								<input type="text" id="subid4" class="subid span80 gen-trigger" />
							</div>
						</div>
						<div class="clearfix row">
							<div class="span80">
								<label for="sourceid">SourceID</label>
								<input type="text" id="sourceid" class="sourceid span80 gen-trigger" />
							</div>
							{% if offer.allow_deeplink %}
							<div class="span160">
								<label for="ulp">ULP (deeplink)</label>
								<input type="text" id="ulp" class="ulp span160 gen-trigger" />
							</div>
							{% endif %}
							{% if offer.allow_cashback %}
							<div class="span160">
								<label for="cashback">CashBack</label>
								<input type="text" id="cashback" class="cashback span160 gen-trigger" />
							</div>
							{% endif %}
						</div>
						<div class="right">
							<a href="#" class="dotted-link code-settings-clear">очистить</a>
						</div>
					</div>
				</div>
				<div class="clearfix placement-container">
					<label for="placement">Выберите размещение</label>
					<select id="placement" class="span9 gen-trigger">
						{% for placement in placements %}
						<option value="{{ placement.id }}">{{ placement.site.name }}</option>
						{% endfor %}
					</select>
				</div>
				<div class="clearfix code-box-container click-url-container" style="display: none;">
					<label for="click-url">Прямая ссылка</label>
					<textarea rows="4" id="click-url" class="span9 code-box"
					 readonly="readonly"></textarea>
				</div>
				<div class="clearfix code-box-container tracking-pixel-container" style="display: none;">
					<label for="tracking-pixel">Код пикселя для трекинга показов</label>
					<textarea rows="4" id="tracking-pixel" class="span9 code-box"
					readonly="readonly"></textarea>
				</div>
				<div class="clearfix code-box-container banner-code-container" style="display: none;">
					<label for="banner-code">Код баннера</label>
					<textarea rows="8" id="banner-code" class="span9 code-box"
					readonly="readonly"></textarea>
				</div>
			</form>
		</div>
	</div>
	{% endif %}
{% endblock %}
