{% import 'common/macros.html' as macros %}
{% import 'common/forms.html' as forms %}

{% macro head() %}
<style type="text/css">
	.collapse-container {
		overflow: hidden;
	}
	
	tr.exclusive td {
		background-color: #DDFFDD;
	}
	
	span.affiliate-value {
		color: #BBB;
		font-size: 80%;
	}
</style>

<script type="text/javascript">
	$(function() {
		var collapseHeight = 150;
		$('.collapse-container').each(function() {
			if ($(this).height() > collapseHeight) {
				$(this).data('origHeight', $(this).height());
				$(this).height(collapseHeight);
				$(this).addClass('collapsed');
				$(this).siblings('.collapse-link').show();
			}
		});
		$('.collapse-link').click(function() {
			var container = $(this).siblings('.collapse-container');
			var animHeight = container.hasClass('collapsed') ? container.data('origHeight') : collapseHeight; 
			container.animate({ height : animHeight }, 'fast').toggleClass('collapsed');
			return false;
		});
	})
</script>
{% endmacro %}

{% macro table(offers, status=false, grant_status=false, user=none, admin=false) %}

{% set affiliate = user.is_affiliate %}

	<table class="bordered-table nosort offers-table">
		<thead>
			<tr>
				<th class="header center" rowspan="2" style="min-width: 180px;">Оффер</th>
				<th class="header center" colspan="2">Действия</th>
				<th class="header" rowspan="2">Описание</th>
				<th class="header right" rowspan="2">Средняя конверсия</th>
				<th class="header" rowspan="2">Регионы</th>
				<th class="header" rowspan="2" style="min-width: 180px;">Категории</th>
			</tr>
			<tr class="subrow">
				<th class="header" style="min-width: 180px;">Название</th>
				<th class="header" style="min-width: 150px;">Оплата</th>
			</tr>
		</thead>
		<tbody>
			{% for offer in offers %}
			{% set rowspan = 'rowspan="{0}"'.format((offer.active_suboffers|length if not offer.exclusive else 0) + 1)|safe %}
			<tr {% if offer.exclusive %}class="exclusive"{% endif %}>
				<td class="center" style="position: relative;" {{ rowspan }}>
					{% if admin %}<div style="position: absolute;">#{{ offer.id }}</div>{% endif %}
					{% if status %}
					<div class="offer-status" style="padding-bottom: 5px;">
						{% if not offer.approved %}
							{% if offer.block_reason %}
							<span class="label important">заблокирован</span>
							{% else %}
							<span class="label info">на модерации</span>
							{% endif %}
						{% elif not offer.active %}
						<span class="label danger">приостановлен</span>
						{% else %}
						<span class="label success">активен</span>
						{% endif %}
					</div>
					{% endif %}
					{% if grant_status and offer.grant %}
					<div class="offer-grant-status" style="padding-bottom: 5px;">
						{% if not offer.approved %}
							<span class="label important">оффер отключен администрацией</span>
						{% elif not offer.active %}
							<span class="label important">оффер отключен рекламодателем</span>
						{% elif offer.grant.blocked %}
							{% if offer.grant.block_reason %}
							<span class="label important">заявка заблокирована администрацией</span>
							{% else %}
							<span class="label info">заявка в рассмотрении</span>
							{% endif %}
						{% else %}
							{% if offer.grant.moderation %}
							<span class="label info">заявка в рассмотрении</span>
							{% elif offer.grant.approved %}
							<span class="label success">сотрудничество</span>
							{% elif offer.grant.rejected %}
							<span class="label important">заявка отклонена</span>
							{% endif %}
						{% endif %}
					</div>
					{% endif %}
					<a href="{{ url_for('.offers_info', id=offer.id) }}">
						{% if offer.logo_filename %}
						<div>
							<img src="{{ url_for('upload', filename=offer.logo) }}"
							alt="логотип" style="max-width: 150px;" />
						</div>
						{% endif %}
						{{ offer.name }}
					</a>
					{% if offer.launch_time %}
					<div class="small center" style="font-style: italic;">
						Дата запуска: {{ offer.launch_time|dateformat }}
					</div>
					{% endif %}
					{% if admin %}
					<div class="well small offer-advertiser">
						<div><a href="{{ url_for('.users_info', id=offer.advertiser.id) }}"
						 >{{ offer.advertiser.full_name or offer.advertiser.email }}</a></div>
						{#<div><a href="mailto:{{ offer.advertiser.email -}}">{{ offer.advertiser.email }}</a></div>#}
						{% if offer.advertiser.organization %}<div>{{ offer.advertiser.organization }}</div>{% endif %}
					</div>
					{% endif %}
				</td>
				
				{% if not offer.exclusive %}
				<td>{{ offer.title }}</td>
				<td>
					{{ offer.value(affiliate) }}
					{% if not affiliate %}
						<br /><span class="affiliate-value">(из них партнёру {{ offer.value(true, short=true) -}})</span>
					{% endif %}
				</td>
				{% else %}
				<td>Покупка товаров на эксклюзивных условиях</td>
				<td><a href="{{ url_for('.offers_info', id=offer.id) }}">см. полное описание</a></td>
				{% endif %}
				
				<td {{ rowspan }}>{{ offer.short_description|default('&mdash;', true)|safe }}</td>
				<td class="right" {{ rowspan }}>
					{% if offer.cr is not none %}{{ offer.cr|percent }}{% else %}(нет&nbsp;данных){% endif %}
				</td>
				
				<td {{ rowspan }}>
					<div class="collapse-container">
					{{ offer.regions_full|attrlist('country_name')|join(', ')|default('(не&nbsp;указаны)', true)|safe }}
					</div>
					<a href="#" class="dotted-link collapse-link" style="display: none;">(ещё)</a>
				</td>
				<td {{ rowspan }}>
					{% if offer.categories %}
					<div class="collapse-container">
						{% with women_categories = offer.women_categories %}
						{% if women_categories %}
						<div class="segments">
							<div class="segments-title">
								<strong>Товары для женщин</strong>
							</div>
							{% for category in women_categories %}							
							<i class="b-ico b-ico_cat_{{ category.css_class -}}"
							 title="{{ category.name }}"></i>
							{% endfor %}
						</div>
						{% endif %}
						{% endwith %}
						<ul class="toplevel-list toplevel-list--no-bottom-margin">
							{% for group in offer.not_women_categories|groupby('grouping') %}
							<li>
								{{ group.grouper }}
								<ul class="dashed-list">
									{% for category in group.list %}
									<li>{{ category.name }}</li>
									{% endfor %}
								</ul>
							</li>
							{% endfor %}
						</ul>
					</div>
					<a href="#" class="dotted-link collapse-link" style="display: none;">(ещё)</a>
					{% else %}
					(не&nbsp;указаны)
					{% endif %}
				</td>
			</tr>
			{% if not offer.exclusive %}
			{% for suboffer in offer.active_suboffers %}
			<tr class="subrow">
				<td>{{ suboffer.title }}</td>
				<td>
					{{ suboffer.value(affiliate) }}
					{% if not affiliate %}
						<br /><span class="affiliate-value">(из них партнёру {{ suboffer.value(true, short=true) -}})</span>
					{% endif %}
				</td>
			</tr>
			{% endfor %}
			{% endif %}
			
			{% endfor %}
		</tbody>
	</table>
{% endmacro %}

{% macro requests_table(requests, offer=false, admin=false, form=none) %}
	<table class="bordered-table nosort offer-grants-table">
		<thead>
			<tr>
				<th class="header">Партнер</th>
				{% if offer %}<th class="header center">Оффер</th>{% endif %}
				<th class="header">Состояние</th>
				{% if not admin %}
				<th class="header center minimal-width" colspan="2">Действия</th>
				{% else %}
				<th class="header center minimal-width" colspan="2">Действия рекламодателя</th>
				<th class="header center minimal-width" colspan="2">Действия администратора</th>
				{% endif %}
			</tr>
		</thead>
		<tbody>
			{% for request in requests %}
			<tr>
				<td>
					{% if admin %}
					<a href="{{ url_for('.users_info', id=request.affiliate.id) }}"
					 >{{ request.affiliate.full_name or request.affiliate.email }}</a>
					{% else %}
					{{ request.affiliate.id }}
					{% endif %}
				</td>
				
				{% if offer %}
				<td>
					<a href="{{ url_for('.offers_info', id=request.offer.id) }}">{{ request.offer.name }}</a>
				</td>
				{% endif %}
				
				<td>
					{% if not request.blocked %}
						{{ request.state.name }}
						{% if request.rejected and request.reject_reason %}
							по причине:<br /><i>{{ request.reject_reason }}</i>
						{% endif %}
					{% else %}
						{% if request.block_reason %}
						заблокирована администрацией по причине:<br /><i>{{ request.block_reason }}</i>
						{% else %}
						проверяется администрацией
						{% endif %}
					{% endif %}
				</td>
				
				{% if request.blocked %}
				<td colspan="2" class="center">&mdash;</td>
				{% else %}
					{% set colspan = 1 if request.moderation else 2 %}
					{% if not request.approved %}
					<td colspan="{{ colspan }}" class="center">
						<a href="#" class="success" data-controls-modal="modal-approve-{{ request.id -}}"
				 		 data-backdrop="true" data-keyboard="true">разрешить</a>
				 		<div id="modal-approve-{{ request.id -}}" class="modal" style="display: none;">
							<form method="post" action="" class="validate2">
								<div class="modal-header">
									<a href="#" class="close">×</a>
									<h3>Подтверждение заявки</h3>
								</div>
								<div class="modal-body">
									<p>Подтвердить заявку?</p>
									{{ form.grant_id(value=request.id) }}
									{{ form.action(value='approve') }}
									{% if admin %}
									{{ form.notify() }} уведомить партнёра
									{% endif %}
								</div>
								<div class="modal-footer">
									<input type="submit" class="btn primary" value="Подтвердить" />
								</div>
							</form>
						</div>
					</td>
					{% endif %}
					{% if not request.rejected %}
					<td colspan="{{ colspan }}" class="center">
						<a href="#" class="danger" data-controls-modal="modal-reject-{{ request.id -}}"
				 		 data-backdrop="true" data-keyboard="true">отклонить</a>
						<div id="modal-reject-{{ request.id -}}" class="modal" style="display: none;">
							<form method="post" action="" class="validate2">
								<div class="modal-header">
									<a href="#" class="close">×</a>
									<h3>Отклонение заявки</h3>
								</div>
								<div class="modal-body">
									<fieldset>
										{{ form.grant_id(value=request.id) }}
										{{ form.action(value='reject') }}
										{{ forms.singlefield(form.reason, class='span6', rows=6) }}
										{% if admin %}
										<div class="input">
										{{ form.notify() }} уведомить партнёра
										</div>
										{% endif %}
									</fieldset>
								</div>
								<div class="modal-footer">
									<input type="submit" class="btn primary" value="Отклонить" />
								</div>
							</form>
						</div>
					</td>
					{% endif %}
				{% endif %}
				
				{% if admin %}
					{% set colspan = 1 if request.blocked else 2 %}
					{% if request.blocked %}
					<td colspan="{{ colspan }}" class="center">
						<a href="#" class="success" data-controls-modal="modal-unblock-{{ request.id -}}"
				 		 data-backdrop="true" data-keyboard="true">разблокировать</a>
				 		<div id="modal-unblock-{{ request.id -}}" class="modal" style="display: none;">
							<form method="post" action="" class="validate2">
								<div class="modal-header">
									<a href="#" class="close">×</a>
									<h3>Разблокирование заявки</h3>
								</div>
								<div class="modal-body">
									<p>Разблокировать заявку?</p>
									{{ form.grant_id(value=request.id) }}
									{{ form.action(value='unblock') }}
									{% if request.state == 'APPROVED' %}
									{{ form.notify() }} уведомить партнёра
									{% endif %}
								</div>
								<div class="modal-footer">
									<input type="submit" class="btn primary" value="Разблокировать" />
								</div>
							</form>
						</div>
					</td>
					{% endif %}
					<td colspan="{{ colspan }}" class="center">
						<a href="#" class="danger" data-controls-modal="modal-block-{{ request.id -}}"
				 		 data-backdrop="true" data-keyboard="true">заблокировать</a>
						<div id="modal-block-{{ request.id -}}" class="modal" style="display: none;">
							<form method="post" action="" class="validate2">
								<div class="modal-header">
									<a href="#" class="close">×</a>
									<h3>Блокировка заявки</h3>
								</div>
								<div class="modal-body">
									<fieldset>
										{{ form.grant_id(value=request.id) }}
										{{ form.action(value='block') }}
										{{ forms.singlefield(form.reason, class='span6', rows=6) }}
										<div class="input">
										{{ form.notify() }} уведомить партнёра
										</div>
									</fieldset>
								</div>
								<div class="modal-footer">
									<input type="submit" class="btn primary" value="Заблокировать" />
								</div>
							</form>
						</div>
					</td>
				{% endif %}
			</tr>
			{% endfor %}
		</tbody>
	</table>
{% endmacro %}
