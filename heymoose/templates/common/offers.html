{% import 'common/macros.html' as macros %}
{% import 'common/forms.html' as forms %}

{% macro head() %}
<style type="text/css">
	.collapse-container {
		overflow: hidden;
	}
	
	tr.exclusive td {
		background-color: #DDFFDD;
	}
	
	span.affiliate-value {
		color: #BBB;
		font-size: 80%;
	}
</style>

<script type="text/javascript">
	$(function() {
		var collapseHeight = 150;
		$('.collapse-container').each(function() {
			if ($(this).height() > collapseHeight) {
				$(this).data('origHeight', $(this).height());
				$(this).height(collapseHeight);
				$(this).addClass('collapsed');
				$(this).siblings('.collapse-link').show();
			}
		});
		$('.collapse-link').click(function() {
			var container = $(this).siblings('.collapse-container');
			var animHeight = container.hasClass('collapsed') ? container.data('origHeight') : collapseHeight; 
			container.animate({ height : animHeight }, 'fast').toggleClass('collapsed');
			return false;
		});
	})
</script>
{% endmacro %}

{% macro table(offers, status=false, user=none) %}

{% set affiliate = user.is_affiliate %}
{% set admin = user.is_admin %}

	<table class="bordered-table nosort offers-table">
		<thead>
			<tr>
				<th class="header center" rowspan="2" style="min-width: 180px;">Оффер</th>
				<th class="header center" colspan="2">Действия</th>
				<th class="header" rowspan="2">Описание</th>
				<th class="header right" rowspan="2">Средняя конверсия</th>
				<th class="header" rowspan="2">Регионы</th>
				<th class="header" rowspan="2" style="min-width: 180px;">Категории</th>
			</tr>
			<tr class="subrow">
				<th class="header" style="min-width: 180px;">Название</th>
				<th class="header" style="min-width: 150px;">Оплата</th>
			</tr>
		</thead>
		<tbody>
			{% for offer in offers %}
			{% set rowspan = 'rowspan="{0}"'.format((offer.active_suboffers|length if not offer.exclusive else 0) + 1)|safe %}
			<tr {% if offer.exclusive %}class="exclusive"{% endif %}>
				<td class="center" style="position: relative;" {{ rowspan }}>
					{% if admin %}<div style="position: absolute;">#{{ offer.id }}</div>{% endif %}
					{% if status %}
					<div class="offer-status" style="padding-bottom: 5px;">
						{% if not offer.approved %}
							{% if offer.block_reason %}
							<span class="label important">отключен администрацией</span>
							{% else %}
							<span class="label info">проверяется администрацией</span>
							{% endif %}
						{% elif not offer.active %}
						<span class="label danger">отключен рекламодателем</span>
						{% else %}
						<span class="label success">активен</span>
						{% endif %}
					</div>
					{% endif %}
					<a href="{{ url_for('.offers_info', id=offer.id) }}">
						{% if offer.logo_filename %}
						<div>
							<img src="{{ url_for('upload', filename=offer.logo) }}"
							alt="логотип" style="max-width: 150px;" />
						</div>
						{% endif %}
						{{ offer.name }}
					</a>
					{% if offer.launch_time %}
					<div class="small center" style="font-style: italic;">
						Дата запуска: {{ offer.launch_time|dateformat }}
					</div>
					{% endif %}
					{% if admin and user.can('view_advertiser') %}
					<div class="well small offer-advertiser">
						<div>
							<a href="{{ url_for('.users_info', id=offer.advertiser.id) }}">{{ offer.advertiser.full_name or offer.advertiser.email }}</a>
						</div>
						{% if offer.advertiser.organization %}
						<div>{{ offer.advertiser.organization }}</div>
						{% endif %}
					</div>
					{% endif %}
				</td>
				
				<td>
					{% if not offer.is_product_offer %}
						{{ offer.title }}
					{% else %}
						Покупка товаров в интернет-магазине.
					{% endif %}
				</td>
				
				<td>
					{% if offer.is_product_offer %}от{% endif %}
					{{ offer.value(affiliate) }}
					{% if not affiliate %}
						<br /><span class="affiliate-value">(из них партнёру {{ offer.value(true, short=true) -}})</span>
					{% endif %}
					{% if offer.is_product_offer %}
						<p><a href="{{ url_for('.offers_info', id=offer.id) }}">см. полное описание</a></p>
					{% endif %}
				</td>
								
				<td {{ rowspan }}>{{ offer.short_description|default('&mdash;', true)|safe }}</td>
				<td class="right" {{ rowspan }}>
					{% if offer.cr is not none %}{{ offer.cr|percent }}{% else %}(нет&nbsp;данных){% endif %}
				</td>
				
				<td {{ rowspan }}>
					<div class="collapse-container">
					{{ offer.regions_full|attrlist('country_name')|join(', ')|default('(не&nbsp;указаны)', true)|safe }}
					</div>
					<a href="#" class="dotted-link collapse-link" style="display: none;">(ещё)</a>
				</td>
				<td {{ rowspan }}>
					{% if offer.categories %}
					<div class="collapse-container">
						{% with women_categories = offer.women_categories %}
						{% if women_categories %}
						<div class="segments">
							<div class="segments-title">
								<strong>Товары для женщин</strong>
							</div>
							{% for category in women_categories %}							
							<i class="b-ico b-ico_cat_{{ category.css_class -}}"
							 title="{{ category.name }}"></i>
							{% endfor %}
						</div>
						{% endif %}
						{% endwith %}
						<ul class="toplevel-list toplevel-list--no-bottom-margin">
							{% for group in offer.not_women_categories|groupby('grouping') %}
							<li>
								{{ group.grouper }}
								<ul class="dashed-list">
									{% for category in group.list %}
									<li>{{ category.name }}</li>
									{% endfor %}
								</ul>
							</li>
							{% endfor %}
						</ul>
					</div>
					<a href="#" class="dotted-link collapse-link" style="display: none;">(ещё)</a>
					{% else %}
					(не&nbsp;указаны)
					{% endif %}
				</td>
			</tr>
			{% if not offer.is_product_offer %}
			{% for suboffer in offer.active_suboffers %}
			<tr class="subrow">
				<td>{{ suboffer.title }}</td>
				<td>
					{{ suboffer.value(affiliate) }}
					{% if not affiliate %}
						<br /><span class="affiliate-value">(из них партнёру {{ suboffer.value(true, short=true) -}})</span>
					{% endif %}
				</td>
			</tr>
			{% endfor %}
			{% endif %}
			
			{% endfor %}
		</tbody>
	</table>
{% endmacro %}
