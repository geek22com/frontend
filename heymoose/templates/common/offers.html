{% import 'common/macros.html' as macros %}
{% import 'common/forms.html' as forms %}

{% macro table(offers, status=false, grant_status=false) %}
	<table class="bordered-table nosort offers-table">
		<thead>
			<tr>
				<th class="header center" rowspan="2">Оффер</th>
				<th class="header center" colspan="2">Действия</th>
				<th class="header center" colspan="3">Показатели</th>
				<th class="header" rowspan="2">Регионы</th>
				<th class="header" rowspan="2">Категории</th>
			</tr>
			<tr class="subrow">
				<th class="header">Название</th>
				<th class="header right" style="min-width: 70px;">Оплата</th>
				{#<th class="header center">Мн.</th>#}
				
				<th class="header right">eCPC,&nbsp;руб.</th>
				<th class="header right">eCPM,&nbsp;руб.</th>
				<th class="header right">CR,&nbsp;%</th>
			</tr>
		</thead>
		<tbody>
			{% for offer in offers %}
			{% set rowspan = 'rowspan="{0}"'.format(offer.suboffers|length + 1)|safe %}
			<tr>
				<td class="center" {{ rowspan }}>
					{% if status %}
					<div class="offer-status" style="padding-bottom: 5px;">
						{% if not offer.approved %}
							{% if offer.block_reason %}
							<span class="label important">заблокирован</span>
							{% else %}
							<span class="label info">на модерации</span>
							{% endif %}
						{% elif not offer.active %}
						<span class="label danger">приостановлен</span>
						{% else %}
						<span class="label success">активен</span>
						{% endif %}
					</div>
					{% endif %}
					{% if grant_status and offer.grant %}
					<div class="offer-grant-status" style="padding-bottom: 5px;">
						{% if offer.grant.blocked %}
							{% if offer.grant.block_reason %}
							<span class="label important">заявка заблокирована администрацией</span>
							{% else %}
							<span class="label info">заявка в рассмотрении</span>
							{% endif %}
						{% else %}
							{% if offer.grant.moderation %}
							<span class="label info">заявка в рассмотрении</span>
							{% elif offer.grant.approved %}
							<span class="label success">сотрудничество</span>
							{% elif offer.grant.rejected %}
							<span class="label important">заявка отклонена</span>
							{% endif %}
						{% endif %}
					</div>
					{% endif %}
					<a href="{{ url_for('.offers_info', id=offer.id) }}">
						{% if offer.logo_filename %}
						<div>
							<img src="{{ url_for('upload', filename=offer.logo) }}"
							alt="логотип" width="150" />
						</div>
						{% endif %}
						{{ offer.name }}
					</a>
				</td>
				
				<td>{{ offer.title }}</td>
				<td class="right">
					{{ offer.cost|currency if offer.cost }}
					{{ offer.percent|percent if offer.percent }}
				</td>
				{#<td class="center">{{ macros.to_icon(offer.reentrant) }}</td>#}
				
				<td class="right" {{ rowspan }}>(нет&nbsp;данных)</td>
				<td class="right" {{ rowspan }}>(нет&nbsp;данных)</td>
				<td class="right" {{ rowspan }}>(нет&nbsp;данных)</td>
				
				<td {{ rowspan }}>{{ offer.regions_ordered|attrlist('name')|join(', ')|default('&mdash;', true)|safe }}</td>
				<td {{ rowspan }}>
					{% if offer.categories %}
					<ul class="toplevel-list toplevel-list--no-bottom-margin">
						{% for group in offer.categories|groupby('grouping') %}
						<li>
							{{ group.grouper }}
							<ul class="dashed-list">
								{% for category in group.list %}
								<li>{{ category.name }}</li>
								{% endfor %}
							</ul>
						</li>
						{% endfor %}
					</ul>
					{% else %}
					(не указаны)
					{% endif %}
				</td>
			</tr>
			{% for suboffer in offer.suboffers %}
			<tr class="subrow">
				<td>{{ suboffer.title }}</td>
				<td class="right">
					{{ suboffer.cost|currency if suboffer.cost }}
					{{ suboffer.percent|percent if suboffer.percent }}
				</td>
				{#<td class="center">{{ macros.to_icon(suboffer.reentrant) }}</td>#}
			</tr>
			{% endfor %}
			{% endfor %}
		</tbody>
	</table>
{% endmacro %}

{% macro requests_table(requests, offer=false, admin=false, form=none) %}
	<table class="bordered-table nosort offer-grants-table">
		<thead>
			<tr>
				{% if admin %}<th class="header">Партнер</th>{% endif %}
				{% if offer %}<th class="header center">Оффер</th>{% endif %}
				<th class="header">Заявка</th>
				<th class="header">Состояние</th>
				<th class="header center minimal-width" colspan="2">Действия</th>
			</tr>
		</thead>
		<tbody>
			{% for request in requests %}
			<tr>
				{% if admin %}
				<td>
					<a href="{{ url_for('.users_info', id=request.affiliate.id) }}"
					 >{{ request.affiliate.full_name }}</a>
				</td>
				{% endif %}
				
				{% if offer %}
				<td>
					<a href="{{ url_for('.offers_info', id=offer.id) }}">
						{% if request.offer.logo_filename %}
						<div>
							<img src="{{ url_for('upload', filename=request.offer.logo) }}"
							alt="логотип" width="150" />
						</div>
						{% endif %}
						{{ request.offer.name }}
					</a>
				</td>
				{% endif %}
				
				<td>{{ request.message }}</td>
				<td>
					{% if not request.blocked %}
						{{ request.state.name }}
						{% if request.rejected and request.reject_reason %}
							по причине:<br /><i>{{ request.reject_reason }}</i>
						{% endif %}
					{% else %}
						{% if request.block_reason %}
						заблокирована администрацией по причине:<br /><i>{{ request.block_reason }}</i>
						{% else %}
						проверяется администрацией
						{% endif %}
					{% endif %}
				</td>
				{% if not admin %}
					{% if request.blocked %}
					<td colspan="2">&mdash;</td>
					{% else %}
						{% set colspan = 1 if request.moderation else 2 %}
						{% if not request.approved %}
						<td colspan="{{ colspan }}" class="center">
							<a href="#" class="success" data-controls-modal="modal-approve-{{ request.id -}}"
					 		 data-backdrop="true" data-keyboard="true">разрешить</a>
					 		<div id="modal-approve-{{ request.id -}}" class="modal" style="display: none;">
								<form method="post" action="" class="validate">
									<div class="modal-header">
										<a href="#" class="close">×</a>
										<h3>Подтверждение заявки</h3>
									</div>
									<div class="modal-body">
										<p>Подтвердить заявку?</p>
										{{ form.grant_id(value=request.id) }}
										{{ form.action(value='approve') }}
									</div>
									<div class="modal-footer">
										<input type="submit" class="btn primary" value="Подтвердить" />
									</div>
								</form>
							</div>
						</td>
						{% endif %}
						{% if not request.rejected %}
						<td colspan="{{ colspan }}" class="center">
							<a href="#" class="danger" data-controls-modal="modal-reject-{{ request.id -}}"
					 		 data-backdrop="true" data-keyboard="true">отклонить</a>
							<div id="modal-reject-{{ request.id -}}" class="modal" style="display: none;">
								<form method="post" action="" class="validate">
									<div class="modal-header">
										<a href="#" class="close">×</a>
										<h3>Отклонение заявки</h3>
									</div>
									<div class="modal-body">
										<fieldset>
											{{ form.grant_id(value=request.id) }}
											{{ form.action(value='reject') }}
											{{ forms.singlefield(form.reason, class='span6', rows=6) }}
										</fieldset>
									</div>
									<div class="modal-footer">
										<input type="submit" class="btn primary" value="Отклонить" />
									</div>
								</form>
							</div>
						</td>
						{% endif %}
					{% endif %}
				{% else %}
					{% set colspan = 1 if request.blocked else 2 %}
					{% if request.blocked %}
					<td colspan="{{ colspan }}" class="center">
						<a href="#" class="success" data-controls-modal="modal-unblock-{{ request.id -}}"
				 		 data-backdrop="true" data-keyboard="true">разблокировать</a>
				 		<div id="modal-unblock-{{ request.id -}}" class="modal" style="display: none;">
							<form method="post" action="" class="validate">
								<div class="modal-header">
									<a href="#" class="close">×</a>
									<h3>Разблокирование заявки</h3>
								</div>
								<div class="modal-body">
									<p>Разблокировать заявку?</p>
									{{ form.grant_id(value=request.id) }}
									{{ form.action(value='unblock') }}
								</div>
								<div class="modal-footer">
									<input type="submit" class="btn primary" value="Разблокировать" />
								</div>
							</form>
						</div>
					</td>
					{% endif %}
					<td colspan="{{ colspan }}" class="center">
						<a href="#" class="danger" data-controls-modal="modal-block-{{ request.id -}}"
				 		 data-backdrop="true" data-keyboard="true">заблокировать</a>
						<div id="modal-block-{{ request.id -}}" class="modal" style="display: none;">
							<form method="post" action="" class="validate">
								<div class="modal-header">
									<a href="#" class="close">×</a>
									<h3>Блокировка заявки</h3>
								</div>
								<div class="modal-body">
									<fieldset>
										{{ form.grant_id(value=request.id) }}
										{{ form.action(value='block') }}
										{{ forms.singlefield(form.reason, class='span6', rows=6) }}
									</fieldset>
								</div>
								<div class="modal-footer">
									<input type="submit" class="btn primary" value="Заблокировать" />
								</div>
							</form>
						</div>
					</td>
				{% endif %}
			</tr>
			{% endfor %}
		</tbody>
	</table>
{% endmacro %}
