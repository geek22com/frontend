{% extends "admin/orders-info-layout.html" %}

{% block breadcrumbs %}
	{{ super() }}
	{{ macros.breadcrumb('Статистика', url_for('.orders_info_stats', id=order.id)) }}
{% endblock %}

{% set activetab = 'stats' %}

{% block extrahead %}
	{{ super() }}
	<script type="text/javascript" src="{{ url_for('.static', filename='./js/jquery.form.js') }}"></script>
	<script type="text/javascript" src="https://www.google.com/jsapi"></script>
	<script type="text/javascript">
		google.load("visualization", "1", {packages:["corechart"]});
		
		function updateCharts() {
			$('#form-ctr').ajaxSubmit({
				dataType: 'json',
				success: function(data, textStatus) {
					drawCharts(data.values);
				},
				error: function(xhr, textStatus) {
					if (xhr.status == 400)
						alert('Параметры введены неверно');
					else
						alert('Ошибка ' + xhr.status + ': ' + textStatus);
				}
			});
		}
		
		function drawCharts(values) {
			var dt = new google.visualization.DataTable();
			dt.addColumn('string', 'Время');
			dt.addColumn('number', 'Показы');
			dt.addColumn('number', 'Клики');
			dt.addRows(values.length);
			
			var dtc = new google.visualization.DataTable();
			dtc.addColumn('string', 'Время');
			dtc.addColumn('number', 'CTR');
			dtc.addRows(values.length);

			var ind = 0;
			$.each(values, function(i, val) {
				dt.setValue(ind, 0, val.time);
				dt.setValue(ind, 1, val.shows);
				dt.setValue(ind, 2, val.clicks);
				
				dtc.setValue(ind, 0, val.time);
				dtc.setValue(ind, 1, val.shows > 0 ? val.clicks/val.shows : 0);
				
				ind++;
			});
			
			var w = Math.max(values.length * 50, 900);
			var h = 300;
			var options = { 
				width: w, height: h, fontSize: 14, legend: 'none',
				hAxis: { slantedText: true, slantedTextAngle: 90 },
				chartArea: { left: 40, top: 30, width: w-40 }
			};
			
			var chClicks = new google.visualization.ColumnChart(document.getElementById('chart-clicks'));
			chClicks.draw(dt, options);
			
			var chCtr = new google.visualization.LineChart(document.getElementById('chart-ctr'));
			chCtr.draw(dtc, options);
		}

		$(function() {
			$('#form-ctr').ajaxForm();
			$('.datetimepicker').datetimepicker({showButtonPanel: false});
			
			updateCharts();
			
			$('#btn-show').click(function() {
				updateCharts();				
				return false;
			});
		});
	</script>
{% endblock %}

{% block tabcontent %}

<h2>Отношение кликов к показам</h2>
<div class="well">
	<form id="form-ctr" method="get" action="{{ url_for('.ajax_orders_info_stats_ctr', id=order.id) }}">
		Дата и время
		с <input class="span3 datetimepicker" type="text" name="from" value="{{ now()|delta(days=-3)|datetime_nosec }}" />
		по <input class="span3 datetimepicker" type="text" name="to" value="{{ now()|datetime_nosec }}" />
		группировать по
		<select class="span3" name="group">
			<option value="minute">минутам</option>
			<option value="hour" selected="selected">часам</option>
			<option value="day">дням</option>
			<option value="month">месяцам</option>
		</select>
		<button id="btn-show" class="btn primary float-right">Показать</button>
	</form>
</div>

<div class="scroll-area-x">
	<div id="chart-clicks"></div>
	<div id="chart-ctr"></div>
</div>

{% endblock %}
