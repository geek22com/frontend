{% extends "admin/apps-layout.html" %}

{% set activetab = 'list' %}

{% block extrahead %}
	{{ super() }}
	<script type="text/javascript">
		$(function() {
			var urlCtr = "{{ url_for('.ajax_apps_ctr', id=apps|attrlist('id'))|safe }}";
			
			$('#show').change(function() { $(this).closest('form').submit(); });
			
			$('#wait-bar').show();
			$.getJSON(urlCtr)
				.complete(function() { $('#wait-bar').hide(); })
				.success(function(data, textStatus) {
					$('tr.app-row').each(function() {
						var stat = data[$(this).data('id')];
						$(this).find('td.app-shows').text(stat.shows);
						$(this).find('td.app-actions').text(stat.actions);
						$(this).find('td.app-ctr').text(stat.ctr);
					});
				})
				.error(function(xhr, textStatus) {
					if (xhr.status)
						alert('Не удалось загрузить статистику. Ошибка ' + xhr.status);
				});
		});
	</script>
{% endblock %}

{% block tabcontent %}

<form method="post" action="">
	{{ form.show() }} {{ form.show.label.text|lower }}
	{{ form.dummy() }}
</form>

{% if apps %}
	<table class="bordered-table zebra-striped nosort apps-table">
		<thead>
			<tr>
				<th class="header right" rowspan="2">ИД</th>
				<th class="header" rowspan="2">Название</th>
				<th class="header" rowspan="2">Разработчик</th>
				<th class="header" rowspan="2">Платформа</th>
				<th class="header center" rowspan="2">Создано</th>
				<th class="center" colspan="3">
					Статистика за две недели
					<img src="{{ url_for('static', filename='img/wait-indicator-24.gif') }}" 
						id="wait-bar" alt="загрузка..." class="float-right" 
						style="position: relative; right: 0; margin: -5px; display: none;"
					/>
				</th>
			</tr>
			<tr class="subrow">
				<th class="right" style="width: 80px;">Показов</th>
				<th class="right" style="width: 80px;">Кликов</th>
				<th class="right" style="width: 80px;">CTR</th>
			</tr>
		</thead>
		<tbody>
			{% for app in apps %}
			<tr class="app-row" data-id="{{ app.id }}">
				<td class="right {% if app.deleted %}deleted{% endif %}">{{ app.id }}</td>
				<td>{{ macros.app_href(app) }}</td>
				<td>{{ macros.user_href(app.user) }}</td>
				<td>{{ app.platform }}</td>
				<td class="center">{{ app.creation_time|datetimeformat }}</td>
				<td class="right app-shows">...</td>
				<td class="right app-actions">...</td>
				<td class="right app-ctr">...</td>
			</tr>
			{% endfor %}
		</tbody>
	</table>
	{{ macros.paginate(pages, '.apps') }}
{% else %}
	<div class="clearfix alert-message block-message info">
		<p><strong>Список пуст.</strong> Еще не было добавлено ни одного приложения.</p>
	</div>
{% endif %}

{% endblock %}